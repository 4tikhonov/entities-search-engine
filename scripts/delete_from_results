#!/usr/bin/env coffee

# Pass the path of a results json file, supposedly made of an array of ids:
# all those ids documents will be deleted
[ index, type, resultPath ] = process.argv.slice(2)
{ host:elasticHost, indexes } = require('config').elastic

path = require 'path'
ids = require path.resolve(resultPath)
breq = require 'bluereq'
_ = require '../lib/utils'
unindex = require '../lib/unindex'

_.info ids.length, 'ids total'

deleteNextBulk = ->
  _.info ids.length, 'remaining'

  idsBatch = ids.splice 0, 1000

  if idsBatch.length is 0
    _.success 'done'
    return

  unindex index, type, idsBatch
  .delay 200
  .then deleteNextBulk

deleteNextBulk()
